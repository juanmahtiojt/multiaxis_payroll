<?php
session_start();
include __DIR__ . "/config.php";  // Include database connection

// Redirect to login if not authenticated
if (!isset($_SESSION['user'])) {
    header("Location: login.php");
    exit();
}

$username = $_SESSION['user']; // Get logged-in username
$role = $_SESSION['role']; // Get user role

// Initialize date range variables
$start_date = $_POST['start_date'] ?? '';
$end_date = $_POST['end_date'] ?? '';

// Initialize deductions query to be empty if no dates are provided
$deductions_result = [];

if ($start_date && $end_date) {
    // If both start_date and end_date are provided, run the query
    $deductions_query = "SELECT * FROM employee_deductions WHERE start_date >= '$start_date' AND end_date <= '$end_date'";  
    $deductions_result = mysqli_query($conn, $deductions_query);
}

$current_page = basename($_SERVER['PHP_SELF']); // Get the current page filename
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Employee Management</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #d6eaf8;
            display: flex;
            min-height: 100vh;
            margin: 0;
        }
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            min-height: 100vh;
            padding-top: 20px;
            position: fixed;
            left: 0;
            top: 0;
        }
        .sidebar a {
            display: block;
            color: white;
            text-decoration: none;
            padding: 15px;
            font-size: 18px;
            transition: 0.3s;
        }
        .sidebar a:hover {
            background-color: #1a252f;
            color: #ffffff !important;
        }
        .sidebar a.active {
            background-color: #d6eaf8;
            color: #000 !important;
        }
        .main-content {
            margin-left: 250px;
            padding: 40px;
            width: calc(100% - 250px);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 40px;
            box-sizing: border-box;
            min-height: 100vh;
        }
        .table-container {
            width: 100%;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0px 6px 20px rgba(0, 0, 0, 0.2);
        }
        .table-container table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        .table-container th, .table-container td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .table-container input {
            width: 100%;
            padding: 5px;
            font-size: 14px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .btn-custom {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
        }
        .btn-custom:hover {
            background-color: #0056b3;
        }

        /* Styles specific to printing */
        @media print {
            body {
                background-color: white;
                margin: 0;
                padding: 0;
            }
            .sidebar {
                display: none;  /* Hide sidebar in print */
            }
            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 10px;
            }
            .table-container {
                width: 100%;
                padding: 10px;
            }
            .table-container table {
                width: 100%;
                border-collapse: collapse;
            }
            .table-container th, .table-container td {
                padding: 8px;
                border: 1px solid #ddd;
                text-align: center;
                font-size: 14px;
            }
            /* Ensure that we print 4 employees per page */
            .table-container {
                page-break-before: always;
            }
            .table-container:nth-child(4n) {
                page-break-before: always;
            }
            /* Remove the print button from the printed page */
            .btn-custom {
                display: none;
            }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h1 class="text-center" style="margin: 0; padding: 0; position: relative; top: -50px;">
            <img src="http://localhost/my_project/images/MULTI-removebg-preview.png" style="width: 200px; height: 200px;">
        </h1>
        <p class="text-center" style="margin-top: -90px; color: white; font-size: 23px; font-weight: bold;">
            Multi Axis Handlers & Tech Inc
        </p>
        <a href="dashboard.php" class="<?= ($current_page == 'dashboard.php') ? 'active' : '' ?>">üè† Dashboard</a>
        <?php if ($role === 'admin') : ?>
            <a href="add_user.php" class="<?= ($current_page == 'add_user.php') ? 'active' : '' ?>">‚ûï Employees</a>
        <?php endif; ?>
        <a href="employee_attendance.php" class="<?= ($current_page == 'employee_attendance.php') ? 'active' : '' ?>">üì¶ Attendance</a>
        <a href="reports.php" class="<?= ($current_page == 'reports.php') ? 'active' : '' ?>">üìä Deductions</a>
        <a href="holiday_overtime.php" class="<?= ($current_page == 'holiday_overtime.php') ? 'active' : ''; ?>">‚è∞ Holiday & Overtime</a>
        <a href="logout.php">üö™ Logout</a>
    </div>

   <!-- Main Content -->
<div class="main-content">
    <div class="table-container">
        <h2 class="text-center" style="margin-top: -30px;">‚è∞ Holiday and Overtime</h2>

        <!-- Date Filter Form -->
        <form method="POST" action="holiday_overtime.php" class="mb-3">
            <div class="row">
                <div class="col-md-5">
                    <label for="start_date">Start Date</label>
                    <input type="date" name="start_date" id="start_date" class="form-control" value="<?= $start_date ?>">
                </div>
                <div class="col-md-5">
                    <label for="end_date">End Date</label>
                    <input type="date" name="end_date" id="end_date" class="form-control" value="<?= $end_date ?>">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn-custom" style="margin-top: 30px;">Filter</button>
                </div>
            </div>
        </form>

        <!-- View Payslips Button -->
        <button class="btn-custom" onclick="window.location.href='view_payslips.php'">View Payslips</button>

        <form method="POST" action="holiday_overtime.php">
            <table>
                <thead>
                    <tr>
                        <th>Employee ID</th>
                        <th>Employee Name</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Subtotal</th>
                        <th>Regular OT</th>
                        <th>Rest Day</th>
                        <th>Rest Day with OT</th>
                        <th>Regular Holiday</th>
                        <th>Regular Holiday with OT</th>
                        <th>Work on Rest Day + Regular Holiday</th>
                        <th>Special Non-Working Holiday</th>
                        <th>Special Holiday with Overtime</th>
                        <th>Total Pay</th>
                    </tr>
                </thead>
                <tbody>
                    <?php if (!empty($deductions_result)) {
                        while ($deduction = mysqli_fetch_assoc($deductions_result)) {
                            $subtotal_minus_deductions = $deduction['subtotal_minus_deductions'];  
                    ?>
                    <tr>
                        <td><?php echo $deduction['employee_id']; ?></td>
                        <td><?php echo $deduction['employee_name']; ?></td>
                        <td><?php echo $deduction['start_date']; ?></td>
                        <td><?php echo $deduction['end_date']; ?></td>
                        <td><?php echo number_format($deduction['subtotal_minus_deductions'], 2); ?></td>
                        <td><input type="number" name="regular_overtime[<?php echo $deduction['employee_id']; ?>]" class="form-control" value="<?php echo $_POST['regular_overtime'][$deduction['employee_id']] ?? 0; ?>"></td>
                        <td><input type="number" name="rest_day[<?php echo $deduction['employee_id']; ?>]" class="form-control" value="<?php echo $_POST['rest_day'][$deduction['employee_id']] ?? 0; ?>"></td>
                        <td><input type="number" name="rest_day_overtime[<?php echo $deduction['employee_id']; ?>]" class="form-control" value="<?php echo $_POST['rest_day_overtime'][$deduction['employee_id']] ?? 0; ?>"></td>
                        <td><input type="number" name="regular_holiday[<?php echo $deduction['employee_id']; ?>]" class="form-control" value="<?php echo $_POST['regular_holiday'][$deduction['employee_id']] ?? 0; ?>"></td>
                        <td><input type="number" name="regular_holiday_overtime[<?php echo $deduction['employee_id']; ?>]" class="form-control" value="<?php echo $_POST['regular_holiday_overtime'][$deduction['employee_id']] ?? 0; ?>"></td>
                        <td><input type="number" name="work_on_rest_regular_holiday[<?php echo $deduction['employee_id']; ?>]" class="form-control" value="<?php echo $_POST['work_on_rest_regular_holiday'][$deduction['employee_id']] ?? 0; ?>"></td>
                        <td><input type="number" name="special_non_working_holiday[<?php echo $deduction['employee_id']; ?>]" class="form-control" value="<?php echo $_POST['special_non_working_holiday'][$deduction['employee_id']] ?? 0; ?>"></td>
                        <td><input type="number" name="special_holiday_overtime[<?php echo $deduction['employee_id']; ?>]" class="form-control" value="<?php echo $_POST['special_holiday_overtime'][$deduction['employee_id']] ?? 0; ?>"></td>
                        <?php
                        // Initialize total_pay with subtotal_minus_deductions
                        $total_pay = $subtotal_minus_deductions;

                        // Add overtime input values if form is submitted
                        if ($_SERVER['REQUEST_METHOD'] == 'POST') {
                            // Get overtime input values from POST
                            $regular_overtime = $_POST['regular_overtime'][$deduction['employee_id']] ?? 0;
                            $rest_day = $_POST['rest_day'][$deduction['employee_id']] ?? 0;
                            $rest_day_overtime = $_POST['rest_day_overtime'][$deduction['employee_id']] ?? 0;
                            $regular_holiday = $_POST['regular_holiday'][$deduction['employee_id']] ?? 0;
                            $regular_holiday_overtime = $_POST['regular_holiday_overtime'][$deduction['employee_id']] ?? 0;
                            $work_on_rest_regular_holiday = $_POST['work_on_rest_regular_holiday'][$deduction['employee_id']] ?? 0;
                            $special_non_working_holiday = $_POST['special_non_working_holiday'][$deduction['employee_id']] ?? 0;
                            $special_holiday_overtime = $_POST['special_holiday_overtime'][$deduction['employee_id']] ?? 0;

                            // Compute Total Pay based on overtime values
                            $total_pay += 
                                ($regular_overtime * 125) +  // Regular Overtime
                                ($rest_day * 1040) +        // Rest Day
                                ($rest_day_overtime * 169) +// Rest Day with Overtime
                                ($regular_holiday * 1600) + // Regular Holiday
                                ($regular_holiday_overtime * 260) + // Regular Holiday with Overtime
                                ($work_on_rest_regular_holiday * 2080) + // Work on Rest Day + Regular Holiday
                                ($special_non_working_holiday * 1040) + // Special Non-Working Holiday
                                ($special_holiday_overtime * 169); // Special Holiday with Overtime
                        }
                        ?>
                        <td><?php echo number_format($total_pay, 2); ?></td>
                    </tr>
                    <?php } } else if ($_SERVER['REQUEST_METHOD'] == 'POST') { ?>
                    <tr>
                        <td colspan="13" class="text-center">No data available for the selected date range</td>
                    </tr>
                    <?php } ?>
                </tbody>
            </table>
            <button type="submit" class="btn-custom">Update Total Pay</button>
        </form>
    </div>
</div>

</body>
</html>
