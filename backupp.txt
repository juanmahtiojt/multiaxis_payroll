<?php
session_start();

if (!isset($_SESSION['user'])) {
    header("Location: login.php");
    exit();
}

$username = $_SESSION['user'];
$role = $_SESSION['role'];
$current_page = basename($_SERVER['PHP_SELF']);

$conn = new mysqli("localhost", "root", "", "payroll_management_system");
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

$sql = "SELECT id_no, department, name, daily_rate, total_pay, date FROM employee_attendance ORDER BY name, date";
$result = $conn->query($sql);
if (!$result) {
    echo "Error: " . $conn->error;
    exit();
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Employee Deductions</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            display: flex;
            height: 100vh;
            margin: 0;
        }
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            height: 100vh;
            padding-top: 20px;
            position: fixed;
            left: 0;
            top: 0;
        }
        .sidebar a {
            display: block;
            color: white;
            text-decoration: none;
            padding: 15px;
            font-size: 18px;
            transition: 0.3s;
        }
        .sidebar a:hover {
            background-color: #1a252f;
            color: #ffffff !important;
        }
        .sidebar a.active {
            background-color: #d6eaf8;
            color: #000 !important;
        }
        .main-content {
            margin-left: 250px;
            padding: 40px;
            width: calc(100% - 250px);
            overflow-y: auto;
        }
        .table-container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0px 6px 20px rgba(0, 0, 0, 0.2);
        }
        .table-wrapper {
            overflow-x: auto;
        }
        .table-container table {
            min-width: 1000px;
        }
        .table-container th, .table-container td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .btn-custom {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
        }
        .btn-custom:hover {
            background-color: #0056b3;
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        .table-container th {
            background-color: #007bff;
            color: white;
        }
        .summary-row {
            font-weight: bold;
            background-color: #f1f1f1;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h1 class="text-center" style="margin: 0; padding: 0; position: relative; top: -50px;">
            <img src="http://localhost/my_project/images/MULTI-removebg-preview.png" style="width: 200px; height: 200px;">
        </h1>
        <p class="text-center" style="margin-top: -90px; color: white; font-size: 23px; font-weight: bold;">
            Multi Axis Handlers & Tech Inc
        </p>
        <a href="dashboard.php" class="<?php echo ($current_page == 'dashboard.php') ? 'active' : ''; ?>">üè† Dashboard</a>
        <?php if ($role === 'admin') : ?>
            <a href="add_user.php" class="<?php echo ($current_page == 'add_user.php') ? 'active' : ''; ?>">‚ûï Employees</a>
        <?php endif; ?>
        <a href="employee_attendance.php" class="<?php echo ($current_page == 'employee_attendance.php') ? 'active' : ''; ?>">üì¶ Attendance</a>
        <a href="reports.php" class="<?php echo ($current_page == 'reports.php') ? 'active' : ''; ?>">üìä Deductions</a>
        <a href="logout.php" class="<?php echo ($current_page == 'logout.php') ? 'active' : ''; ?>">üö™ Logout</a>
    </div>

    <div class="main-content">
        <div class="table-container">
            <h2 class="text-center">üìä Employee Deductions</h2>
            <div class="search-container">
                <input type="text" id="searchName" class="form-control" placeholder="Search by Name" onkeyup="searchTable()">
                <button class="btn-custom" onclick="clearSearch()">Clear</button>
            </div>
            <div class="table-wrapper">
                <table id="employeeTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Employee Name</th>
                            <th>ID No.</th>
                            <th>Department</th>
                            <th>Daily Rate</th>
                            <th>Daily Wage</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
<?php
if ($result->num_rows > 0) {
    $currentName = "";
    $currentIdNo = "";
    $totalDailyRate = 0;
    $totalDailyWage = 0;
    $startDate = $endDate = '';

    while ($row = $result->fetch_assoc()) {
        if ($row['name'] !== $currentName) {
            if ($currentName !== "") {
                // Deductions check
                $checkSql = "SELECT * FROM employee_deductions WHERE employee_id = ? AND start_date = ? AND end_date = ?";
                $stmt = $conn->prepare($checkSql);
                $stmt->bind_param("sss", $currentIdNo, $startDate, $endDate);
                $stmt->execute();
                $checkResult = $stmt->get_result();
                $isSaved = $checkResult->num_rows > 0 ? " (Saved)" : "";

                $sss = $totalDailyRate * 0.05;
                $pagibig = $totalDailyRate * 0.01;
                $philhealth = $totalDailyRate * 0.0225;
                $totalDeductions = $sss + $pagibig + $philhealth;
                $subtotalMinusDeductions = $totalDailyWage - $totalDeductions;

                echo "<tr class='summary-row'><td colspan='4' class='text-end'>Subtotal Daily Wage:</td><td>‚Ç±" . number_format($totalDailyWage, 2) . "</td><td colspan='2'></td></tr>";
                echo "<tr class='summary-row'><td colspan='4' class='text-end'>Subtotal Daily Rate:</td><td>‚Ç±" . number_format($totalDailyRate, 2) . "</td>
                    <td colspan='2'>
                        <form action='submit_deductions.php' method='POST'>
                            <input type='hidden' name='employee_id' value='" . $currentIdNo . "'>
                            <input type='hidden' name='employee_name' value='" . $currentName . "'>
                            <input type='hidden' name='start_date' value='" . $startDate . "'>
                            <input type='hidden' name='end_date' value='" . $endDate . "'>
                            <input type='hidden' name='subtotal_daily_wage' value='" . $totalDailyWage . "'>
                            <input type='hidden' name='subtotal_minus_deductions' value='" . $subtotalMinusDeductions . "'>
                            <button type='submit' class='btn-custom'>" . ($isSaved ? "Saved" : "Save Deduction") . "</button>
                        </form>
                    </td>
                </tr>";
                echo "<tr class='summary-row'><td colspan='4' class='text-end'>Total Deductions:</td><td>‚Ç±" . number_format($totalDeductions, 2) . "</td><td colspan='2'></td></tr>";
                echo "<tr class='summary-row'><td colspan='4' class='text-end'>Subtotal Daily Wage - Total Deductions:</td><td>‚Ç±" . number_format($subtotalMinusDeductions, 2) . "</td><td colspan='2'></td></tr>";
            }

            $currentName = $row['name'];
            $currentIdNo = $row['id_no'];
            $totalDailyRate = 0;
            $totalDailyWage = 0;
            $startDate = $row['date'];
        }

        $totalDailyRate += $row['daily_rate'];
        $totalDailyWage += $row['total_pay'];
        $endDate = $row['date'];

        echo "<tr>
                <td>" . htmlspecialchars($row['name']) . "</td>
                <td>" . $row['id_no'] . "</td>
                <td>" . $row['department'] . "</td>
                <td>‚Ç±" . number_format($row['daily_rate'], 2) . "</td>
                <td>‚Ç±" . number_format($row['total_pay'], 2) . "</td>
                <td>" . date('m/d/Y', strtotime($row['date'])) . "</td>
            </tr>";
    }

    if ($currentName !== "") {
        $checkSql = "SELECT * FROM employee_deductions WHERE employee_id = ? AND start_date = ? AND end_date = ?";
        $stmt = $conn->prepare($checkSql);
        $stmt->bind_param("sss", $currentIdNo, $startDate, $endDate);
        $stmt->execute();
        $checkResult = $stmt->get_result();
        $isSaved = $checkResult->num_rows > 0 ? " (Saved)" : "";

        $sss = $totalDailyRate * 0.05;
        $pagibig = $totalDailyRate * 0.01;
        $philhealth = $totalDailyRate * 0.0225;
        $totalDeductions = $sss + $pagibig + $philhealth;
        $subtotalMinusDeductions = $totalDailyWage - $totalDeductions;

        echo "<tr class='summary-row'><td colspan='4' class='text-end'>Subtotal Daily Wage:</td><td>‚Ç±" . number_format($totalDailyWage, 2) . "</td><td colspan='2'></td></tr>";
        echo "<tr class='summary-row'><td colspan='4' class='text-end'>Subtotal Daily Rate:</td><td>‚Ç±" . number_format($totalDailyRate, 2) . "</td>
            <td colspan='2'>
                <form action='submit_deductions.php' method='POST'>
                    <input type='hidden' name='employee_id' value='" . $currentIdNo . "'>
                    <input type='hidden' name='employee_name' value='" . $currentName . "'>
                    <input type='hidden' name='start_date' value='" . $startDate . "'>
                    <input type='hidden' name='end_date' value='" . $endDate . "'>
                    <input type='hidden' name='subtotal_daily_wage' value='" . $totalDailyWage . "'>
                    <input type='hidden' name='subtotal_minus_deductions' value='" . $subtotalMinusDeductions . "'>
                    <button type='submit' class='btn-custom'>" . ($isSaved ? "Saved" : "Save Deduction") . "</button>
                </form>
            </td>
        </tr>";
        echo "<tr class='summary-row'><td colspan='4' class='text-end'>Total Deductions:</td><td>‚Ç±" . number_format($totalDeductions, 2) . "</td><td colspan='2'></td></tr>";
        echo "<tr class='summary-row'><td colspan='4' class='text-end'>Subtotal Daily Wage - Total Deductions:</td><td>‚Ç±" . number_format($subtotalMinusDeductions, 2) . "</td><td colspan='2'></td></tr>";
    }
} else {
    echo "<tr><td colspan='7' class='text-center'>No records found</td></tr>";
}
?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function searchTable() {
            let input = document.getElementById("searchName").value.toUpperCase();
            let table = document.getElementById("employeeTable");
            let tr = table.getElementsByTagName("tr");

            for (let i = 1; i < tr.length; i++) {
                let td = tr[i].getElementsByTagName("td")[0];
                if (td) {
                    let textValue = td.textContent || td.innerText;
                    tr[i].style.display = textValue.toUpperCase().indexOf(input) > -1 ? "" : "none";
                }
            }
        }

        function clearSearch() {
            document.getElementById("searchName").value = "";
            searchTable();
        }
    </script>
</body>
</html>
<?php $conn->close(); ?>
